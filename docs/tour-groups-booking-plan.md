# План реализации страницы групп туров и бронирования

## Цели
- Создать публичную страницу со списком групп туров.
- Добавить фильтр по месяцу и году для даты начала группы.
- Реализовать модальное окно бронирования из карточки группы.
- По отправке формы: записывать в `contact_messages` и отправлять email администратору.

## Требования функционала
- Список групп с пагинацией и загрузкой связанных туров.
- Фильтрация по `starts_at` (месяц + год), с вариантами «Все месяцы/годы».
- Карточка: название тура, дата/время старта, свободные места, цена для 1 человека (`price_max`) и для полной группы (`price_min`).
- Кнопка «Забронировать» активна только при наличии свободных мест.
- Модальное окно с формой: `name`, `email`, `phone` (опц.), `comment` (опц.), `people_count` (≥1), скрытое поле `hp` (honeypot).
- Валидация формы и пользовательские уведомления.

## Маршруты
- Добавить маршрут: `GET /tour-groups` → `App\Livewire\Front\TourGroupsIndexComponent`, имя `front.tour-groups`.

## Компоненты Livewire
- `Front\TourGroupsIndexComponent`:
  - Состояние: `month`, `year`, `perPage`.
  - Запрос: `TourGroup::with('tour')` + `when($month, whereMonth)` + `when($year, whereYear)` + `orderBy('starts_at')`.
  - Рендер: сетка карточек, фильтры, пагинация, кнопка «Забронировать».
  - Открытие модального окна и передача выбранной группы.
- `Front\BookingModalComponent` (или внутренняя форма в Index-компоненте):
  - Поля: `name`, `email`, `phone?`, `comment?`, `people_count`, `hp`, `tour_group_id`.
  - Валидация: `name: required|string|max:255`, `email: required|email|max:255`, `phone: nullable|string|max:50`, `comment: nullable|string|max:2000`, `people_count: integer|min:1`, `hp: nullable|prohibited`.
  - `submit()`: проверка свободных мест, формирование сообщения, сохранение `ContactMessage`, отправка письма, события UI (`messagesUpdated`, закрытие модала).

## Интерфейс и фильтры
- Фильтры: селекты «Месяц» и «Год» с `wire:model`, значения по умолчанию — текущие.
- Карточка группы:
  - Дата: формат `d.m.Y` и время `H:i`.
  - Свободные места: бейдж (цвет по проценту доступности).
  - Цена: для 1 человека и для `max_people`.
  - Кнопка «Забронировать» (disabled при отсутствии мест).
- Модал: Bootstrap-стили уже в проекте; унификация внешнего вида с существующими фронт-страницами.

## Данные и Email
- Модель `App\Models\ContactMessage` с fillable: `name,email,phone,message,ip,user_agent,is_read`.
- Формат сообщения для записи в БД/email:
  - «Заявка на бронирование тура: {tour_title}. Группа: {starts_at}. Людей: {people_count}. Имя: {name}. Email: {email}. Телефон: {phone|-}. {Комментарий: {comment}}».
- Email: `App\Mail\ContactReceived` (очередь поддерживается), шаблон `emails.contact-received`.
- Получатель: `env('MAIL_TO_ADDRESS')` или `config('mail.from.address')`.
- После сохранения — диспатч `messagesUpdated` для обновления счетчика непрочитанных.

## I18n
- Ключи переводов: `messages.book_now`, `messages.sold_out`, `messages.available_dates`, `messages.booking_info`, и др.
- Добавить недостающие ключи в `lang/*/messages.php`.

## Безопасность и качество
- Антиспам: honeypot `hp` как в контактной форме.
- Проверка доступных мест до отправки.
- Логирование ошибок сохранения и отправки письма.
- Rate-limit по IP при необходимости (позже).

## Проверка
- Ручные сценарии:
  - Фильтрация по месяцам/годам, пагинация.
  - Бронирование при наличии мест, корректная валидация, успех/ошибка.
  - Запись в `contact_messages`, email доставляется (по логу и тестовой почте).
- Визуальная проверка доступных групп на странице тура; единообразие UX.

## Этапы внедрения
1. Маршрут и каркас `TourGroupsIndexComponent`.
2. Фильтры по месяцу/году и вывод карточек.
3. Модальное окно бронирования и форма.
4. Логика `submit()`: запись `ContactMessage` + отправка email.
5. Переводы, стили, уведомления.
6. Тестирование и корректировки.

## Риски и ограничения
- Отсутствие настроенного `MAIL_TO_ADDRESS` → лог-предупреждение, без влияния на UX.
- Разночтения полей цены (`price_min/max`) и расчетов — уточнить при необходимости.
- Очереди почты требуют конфигурации; при её отсутствии письмо отправляется синхронно.

